name: CI – Lint, Accessibility & Smoke Test

on:
  push:
    branches: [main, preview]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Security Patterns
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ESLint
        run: npm install --save-dev eslint@8 eslint-plugin-react@latest

      - name: Create ESLint config
        run: |
          cat > .eslintrc.json << 'ESLINTEOF'
          {
            "env": { "browser": true, "es2021": true },
            "parserOptions": {
              "ecmaVersion": "latest",
              "ecmaFeatures": { "jsx": true },
              "sourceType": "script"
            },
            "plugins": ["react"],
            "globals": {
              "React": "readonly",
              "ReactDOM": "readonly",
              "trackEvent": "readonly",
              "gtag": "readonly"
            },
            "rules": {
              "no-eval": "error",
              "no-implied-eval": "error",
              "no-new-func": "error",
              "no-script-url": "error",
              "no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }],
              "no-undef": "error",
              "react/jsx-uses-react": "error",
              "react/jsx-uses-vars": "error"
            }
          }
          ESLINTEOF

      - name: Run ESLint on app.jsx
        run: npx eslint app.jsx --max-warnings 20

      - name: Check for dangerous patterns in HTML
        run: |
          echo "Checking for innerHTML usage..."
          if grep -rn 'innerHTML\|dangerouslySetInnerHTML\|document\.write\b' app.jsx app.js index.html --include='*.jsx' --include='*.js' --include='*.html' | grep -v 'printWindow.document.write' | grep -v 'node_modules'; then
            echo "::warning::Found potentially dangerous DOM manipulation patterns"
          fi
          echo "Checking for eval patterns..."
          if grep -rn '\beval\s*(' app.jsx app.js index.html | grep -v 'node_modules'; then
            echo "::error::Found eval() usage – this is a security risk"
            exit 1
          fi
          echo "All security pattern checks passed"

  build:
    name: Build CSS & JS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build JS (Babel)
        run: npm run build:js

      - name: Build CSS (Tailwind)
        run: npm run build:css

      - name: Verify build outputs exist
        run: |
          test -f app.js || (echo "::error::app.js not generated" && exit 1)
          test -f app.css || (echo "::error::app.css not generated" && exit 1)
          echo "Build outputs verified"

      - name: Check app.js size
        run: |
          SIZE=$(wc -c < app.js)
          echo "app.js size: $SIZE bytes"
          if [ "$SIZE" -gt 500000 ]; then
            echo "::warning::app.js exceeds 500KB ($SIZE bytes)"
          fi

      - name: Check app.css size
        run: |
          SIZE=$(wc -c < app.css)
          echo "app.css size: $SIZE bytes"
          if [ "$SIZE" -gt 300000 ]; then
            echo "::warning::app.css exceeds 300KB ($SIZE bytes) – consider purging unused Tailwind classes"
          fi

  smoke-test:
    name: Smoke Test (Headless)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Run smoke test
        run: |
          node << 'SMOKEEOF'
          const puppeteer = require('puppeteer');
          const http = require('http');
          const fs = require('fs');
          const path = require('path');

          const MIME = {
            '.html': 'text/html', '.js': 'application/javascript',
            '.css': 'text/css', '.json': 'application/json',
            '.png': 'image/png', '.ico': 'image/x-icon',
          };

          const server = http.createServer((req, res) => {
            let filePath = '.' + (req.url === '/' ? '/index.html' : req.url.split('?')[0]);
            const ext = path.extname(filePath);
            fs.readFile(filePath, (err, data) => {
              if (err) { res.writeHead(404); res.end(); return; }
              res.writeHead(200, { 'Content-Type': MIME[ext] || 'application/octet-stream' });
              res.end(data);
            });
          });

          (async () => {
            await new Promise(r => server.listen(3000, r));
            const browser = await puppeteer.launch({ headless: 'new', args: ['--no-sandbox'] });
            const page = await browser.newPage();
            const errors = [];
            page.on('pageerror', e => errors.push(e.message));

            await page.goto('http://localhost:3000', { waitUntil: 'networkidle0', timeout: 30000 });

            // Check #root has content
            const rootContent = await page.$eval('#root', el => el.innerHTML.length);
            if (rootContent < 100) throw new Error('#root has insufficient content (' + rootContent + ' chars)');

            // Check key text exists
            const bodyText = await page.evaluate(() => document.body.innerText);
            const requiredTexts = ['Swim Meet', 'Score', 'Settings'];
            for (const t of requiredTexts) {
              if (!bodyText.includes(t)) throw new Error('Missing UI text: ' + t);
            }

            // Check no JS errors
            if (errors.length > 0) {
              console.error('Page errors:', errors);
              throw new Error('Page had JS errors: ' + errors.join('; '));
            }

            console.log('Smoke test PASSED');
            await browser.close();
            server.close();
          })().catch(e => { console.error('SMOKE TEST FAILED:', e.message); process.exit(1); });
          SMOKEEOF

  accessibility:
    name: Accessibility (Pa11y)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install Pa11y & serve
        run: npm install pa11y serve

      - name: Run Pa11y accessibility check
        run: |
          npx serve -l 3001 -s . &
          sleep 3
          npx pa11y http://localhost:3001 \
            --standard WCAG2AA \
            --ignore "WCAG2AA.Principle1.Guideline1_4.1_4_3.G18.Fail" \
            --threshold 10 || true
          kill %1 || true

  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run existing tests
        run: |
          node tests/notification-positioning.test.js
          node tests/template-events.test.js
